name: Generate & Deploy EPG (7 days)

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 19 * * *"   # Daily at 00:30 IST (~19:00 UTC)
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  epg_job:
    runs-on: ubuntu-latest
    name: Generate EPG & Deploy

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytz

    - name: CREATE Python Script + Run it
      env:
        TZ: Asia/Kolkata
      run: |
        echo "=== Creating generate_epg_7day.py ==="

        cat << 'EOF' > generate_epg_7day.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Auto-Generated EPG Builder
Outputs: epg.xml + epg.xml.gz
"""

import os, json, gzip
from datetime import datetime, timedelta
import pytz
import xml.etree.ElementTree as ET

CHANNELS_FILE = "channel.json"
OUTPUT = "epg.xml"
OUTPUT_GZ = "epg.xml.gz"

DEFAULT_DAYS = 7
DEFAULT_SLOT_MINUTES = 30
TZ = pytz.timezone("Asia/Kolkata")

env_start = os.getenv("START_DATE_OVERRIDE")
env_days = os.getenv("DAYS")
env_slot = os.getenv("SLOT_MINUTES")

# START DATE logic
if env_start:
    START_DATE = datetime.strptime(env_start, "%Y-%m-%dT%H:%M:%S")
    START_DATE = TZ.localize(START_DATE)
else:
    now = datetime.now(TZ)
    START_DATE = now.replace(hour=0, minute=0, second=0, microsecond=0)

try: DAYS = int(env_days) if env_days else DEFAULT_DAYS
except: DAYS = DEFAULT_DAYS

try: SLOT_MINUTES = int(env_slot) if env_slot else DEFAULT_SLOT_MINUTES
except: SLOT_MINUTES = DEFAULT_SLOT_MINUTES

PROGRAM_TITLES = [
    "Morning Show","Daily News","Prime Drama","Movie Time","Kids Hour",
    "Evening Sports","Music Mix","Late Night Special","Documentary Hour","Talk Show"
]
PROGRAM_DESCS = [
    "A lively talk and music show.","Latest news & headlines.","A dramatic serial episode.",
    "Featured movie presentation.","Cartoons and kids entertainment.",
    "Live sports highlights & analysis.","Top chart music videos.",
    "Late-night interviews and features.","A deep-dive documentary.","Celebrity chat and gossip."
]

with open(CHANNELS_FILE, "r", encoding="utf-8") as f:
    channels = json.load(f)

tv = ET.Element("tv")
tv.set("generator-info-name", "GitHub-EPG-Auto")

for ch in channels:
    tvg = ch.get("tvg-id")
    if not tvg: continue
    c = ET.SubElement(tv, "channel", {"id": str(tvg)})
    dn = ET.SubElement(c, "display-name")
    dn.text = ch.get("channel-name", "Unknown")
    logo = ch.get("tvg-logo")
    if logo: ET.SubElement(c, "icon", {"src": logo})

slot_td = timedelta(minutes=SLOT_MINUTES)

for ch in channels:
    tvg = ch.get("tvg-id")
    if not tvg: continue
    cur = START_DATE
    end = START_DATE + timedelta(days=DAYS)
    idx = 0
    while cur < end:
        start = cur.strftime("%Y%m%d%H%M%S %z")
        stop_t = cur + slot_td
        stop = stop_t.strftime("%Y%m%d%H%M%S %z")
        p = ET.SubElement(tv, "programme", {
            "start": start,
            "stop": stop,
            "channel": str(tvg)
        })
        t = ET.SubElement(p, "title", {"lang":"en"}); t.text = PROGRAM_TITLES[idx % 10]
        d = ET.SubElement(p, "desc", {"lang":"en"}); d.text = PROGRAM_DESCS[idx % 10]
        c = ET.SubElement(p, "category", {"lang":"en"})
        c.text = ch.get("group-title", "General")
        cur = stop_t
        idx += 1

# indent formatting
def indent(e, lvl=0):
    i = "\n" + lvl*"  "
    if len(e):
        if not e.text or not e.text.strip(): e.text = i+"  "
        for c in e: indent(c, lvl+1)
        if not e.tail or not e.tail.strip(): e.tail = i
    else:
        if lvl and (not e.tail or not e.tail.strip()): e.tail = i

indent(tv)
ET.ElementTree(tv).write(OUTPUT, encoding="utf-8", xml_declaration=True)

with open(OUTPUT, "rb") as f_in:
    with gzip.open(OUTPUT_GZ, "wb") as f_out:
        f_out.writelines(f_in)

print("Generated:", OUTPUT, OUTPUT_GZ)
EOF

        echo "=== Compute START_DATE_OVERRIDE (IST midnight) ==="
        export START_DATE_OVERRIDE=$(python - << 'PY'
from datetime import datetime
import pytz
tz = pytz.timezone("Asia/Kolkata")
print(datetime.now(tz).replace(hour=0,minute=0,second=0,microsecond=0).strftime("%Y-%m-%dT%H:%M:%S"))
PY
)
        echo "START_DATE_OVERRIDE=$START_DATE_OVERRIDE"

        python generate_epg_7day.py

    - name: Show preview
      run: |
        head -n 30 epg.xml

    - name: Upload artifact (SUPPORTED v4)
      uses: actions/upload-pages-artifact@v4
      with:
        path: epg.xml.gz

    - name: Configure GitHub Pages
      uses: actions/configure-pages@v4

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4

    - name: Show final URL
      run: |
        echo "======================================"
        echo "Your EPG is now deployed!"
        echo "URL:"
        echo "https://<USERNAME>.github.io/<REPO>/epg.xml.gz"
        echo "======================================"
