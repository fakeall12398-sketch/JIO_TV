name: Generate & Deploy EPG (7 days)

on:
  push:
    branches: [ "main" ]
  schedule:
    # Daily â€” adjust if you want a different time.
    # This cron runs at 19:00 UTC every day (~00:30 IST next day).
    - cron: '0 19 * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Generate EPG and Deploy to GitHub Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytz

      - name: Compute START_DATE_OVERRIDE (midnight IST) and run generator
        env:
          TZ: Asia/Kolkata
        run: |
          # compute today's midnight in Asia/Kolkata and export to START_DATE_OVERRIDE
          START_DATE_OVERRIDE=$(python - <<'PY'
from datetime import datetime
import pytz
tz = pytz.timezone("Asia/Kolkata")
mid = datetime.now(tz).replace(hour=0, minute=0, second=0, microsecond=0)
print(mid.strftime("%Y-%m-%dT%H:%M:%S"))
PY
)
          echo "START_DATE_OVERRIDE=$START_DATE_OVERRIDE"
          export START_DATE_OVERRIDE
          # Also allow overriding DAYS or SLOT_MINUTES via repo secrets/env if desired
          # Run generator (it will read START_DATE_OVERRIDE from env)
          python generate_epg_7day.py

      - name: Preview generated epg.xml
        run: |
          echo "=== epg.xml preview ==="
          head -n 80 epg.xml || true
          echo "=== end preview ==="

      - name: Ensure gz exists (just in case)
        run: |
          if [ -f epg.xml.gz ]; then
            echo "epg.xml.gz exists"
          else
            echo "gz missing; creating now"
            gzip -c epg.xml > epg.xml.gz
          fi
          ls -lh epg.xml epg.xml.gz

      - name: Upload Pages artifact (v4)
        uses: actions/upload-pages-artifact@v4
        with:
          path: epg.xml.gz

      - name: Configure Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages (v4)
        uses: actions/deploy-pages@v4

      - name: Show Pages URL hint
        run: |
          echo "If Pages is enabled, your file will be available at:"
          echo "  https://<USERNAME>.github.io/<REPO>/epg.xml.gz"
          echo "Replace <USERNAME> and <REPO> with your repository details."
