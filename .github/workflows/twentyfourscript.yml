name: Update 247_kids M3U Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: pip install requests

    - name: Generate and update kids playlist
      run: |
        cat > update_playlist.py << 'EOF'
        #!/usr/bin/env python3
        
        import requests, re, os
        
        PLAYLIST_SOURCE = "https://livetv-cb7.pages.dev/opp_temp.m3u"
        OUTPUT_FILE = "24_7_channels.m3u"
        TIMEOUT = 10

        WHITELIST_CHANNELS = [
            "motu patlu","shiva","chuchu","baal veer","chacha bhatija","wow kids",
            "vir the robot","doraemon","pink panther","mr bean","kids","coComelon",
            "scooby","peppa","blippi","chhota bheem","tom & jerry","booba"
        ]

        def fetch_playlist(url):
            try:
                return requests.get(url, timeout=TIMEOUT).text
            except:
                return None

        def is_kids_channel(extinf_line):
            text = extinf_line.lower()
            return any(ch.lower() in text for ch in WHITELIST_CHANNELS)

        def extract_channels(content):
            lines = content.splitlines()
            results = []
            for i, line in enumerate(lines):
                if line.startswith("#EXTINF"):
                    if is_kids_channel(line):
                        # Next non-comment line is the URL
                        for j in range(i+1, len(lines)):
                            if lines[j].startswith("http"):
                                results.append((line, lines[j]))
                                break
            return results

        if __name__ == "__main__":
            content = fetch_playlist(PLAYLIST_SOURCE)
            if not content:
                print("âš  Failed to download playlist")
                exit(1)

            channels = extract_channels(content)

            with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                f.write("#EXTM3U\n")
                for extinf, url in channels:
                    f.write(f"{extinf}\n{url}\n\n")

            print(f"âœ… Updated Kids Playlist: {len(channels)} channels saved")
        EOF

        python update_playlist.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add 24_7_channels.m3u
        git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update 24_7_channels.m3u [skip ci]" && git push)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
