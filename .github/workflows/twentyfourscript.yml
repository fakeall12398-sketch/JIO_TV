name: Update 247_kids M3U Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: pip install requests

    - name: Generate and update kids playlist
      run: |
        cat > update_playlist.py << 'EOF'
        #!/usr/bin/env python3
        
        import requests, re, os
        
        PLAYLIST_SOURCE = "https://fakeall12398-sketch.github.io/JIO_TV/Opplex.m3u"
        OUTPUT_FILE = "24_7_channels.m3u"
        TIMEOUT = 10

        WHITELIST_CHANNELS = [
            "24/7 MOTU PATLU 01", "24/7 MOTU PATLU 02", "24/7 SHIVA", "24/7 CHUCHU TV", 
            "24/7 Baal Veer", "24/7 Chacha Bhatija", "24/7 Wow Kids Action", 
            "24/7 Vir The Robot Boy", "24/7 KIDS | DORAEMON", "KIDS: PINK PANTHER 24/7", 
            "KIDS: CHU CHU TV 24/7", "KIDS: Sonic 24/7", "KIDS: MR BEAN (CARTOON) 24/7", 
            "KIDS: CoComelon TV 24/7", "24/7 Kids: All Hail King Julien_ Exiled", 
            "24/7 Kids: Rick And Morty", "24/7 Kids: Masha and the Bear", 
            "24/7 Kids: Little Baby Bum", "24/7 Kids: The Boss Baby_ Back in Business", 
            "24/7 Kids: Peppa Pig", "24/7 Kids: Blippi", "24/7 Kids: Kids: Gabby_s Dollhouse", 
            "24/7 Chhota Bheem", "24/7 Tom & Jerry", "24/7 Scooby-Doo", "24/7 Booba", 
            "24/7 KIDS SONGS HINDI", "24/7 BabyBus | Nursery Rhymes", "24/7 KIDS | MOV HINDI", 
            "24/7 KIDS | MOVIES", "24/7 KIDS | MOVIES ENG 01", "24/7 KIDS | MOVIES ENG 02", 
            "ID: 24/7 Angry Birds Toons", "ID: 24/7 BabyBus Indonesia", "ID: 24/7 Donald Ducks", 
            "ID: 24/7 Doraemon", "ID: 24/7 Just For Laughs", "ID: 24/7 Mr Bean Cartoon", 
            "ID: 24/7 Mr. Bean Classic", "ID: 24/7 Tom And Jerry"
        ]

        def fetch_playlist(url):
            try:
                return requests.get(url, timeout=TIMEOUT).text
            except:
                return None

        def is_kids_channel(extinf_line):
            text = extinf_line.lower()
            return any(ch.lower() in text for ch in WHITELIST_CHANNELS)

        def extract_channels(content):
            lines = content.splitlines()
            results = []
            for i, line in enumerate(lines):
                if line.startswith("#EXTINF"):
                    if is_kids_channel(line):
                        # Next non-comment line is the URL
                        for j in range(i+1, len(lines)):
                            if lines[j].startswith("http"):
                                results.append((line, lines[j]))
                                break
            return results

        if __name__ == "__main__":
            content = fetch_playlist(PLAYLIST_SOURCE)
            if not content:
                print("âš  Failed to download playlist")
                exit(1)

            channels = extract_channels(content)

            with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                f.write("#EXTM3U\n")
                for extinf, url in channels:
                    f.write(f"{extinf}\n{url}\n\n")

            print(f"âœ… Updated Kids Playlist: {len(channels)} channels saved")
        EOF

        python update_playlist.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add 24_7_channels.m3u
        git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update 24_7_channels.m3u [skip ci]" && git push)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


