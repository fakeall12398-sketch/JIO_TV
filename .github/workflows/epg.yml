name: Generate XMLTV EPG

on:
  push:
    paths:
      - "jstar.m3u"
      - "jio.xml.gz"
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"   # update every 12 hours

jobs:
  generate-epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build epg.xml from XMLTV
        run: |
          python3 << 'EOF'
          import gzip
          import re
          import xml.etree.ElementTree as ET

          # -----------------------------
          # 1. Load tvg-ids from M3U
          # -----------------------------
          tvg_ids = set()
          with open("jstar.m3u", encoding="utf-8", errors="ignore") as f:
              for line in f:
                  match = re.search(r'tvg-id="([^"]+)"', line)
                  if match:
                      tvg_ids.add(match.group(1))

          print(f"Found {len(tvg_ids)} tvg-ids")

          # -----------------------------
          # 2. Parse XMLTV
          # -----------------------------
          with gzip.open("jio.xml.gz", "rt", encoding="utf-8") as f:
              tree = ET.parse(f)

          root = tree.getroot()
          new_root = ET.Element("tv")

          # copy metadata if present
          for k, v in root.attrib.items():
              new_root.set(k, v)

          # -----------------------------
          # 3. Copy channels
          # -----------------------------
          channel_count = 0
          for channel in root.findall("channel"):
              if channel.attrib.get("id") in tvg_ids:
                  new_root.append(channel)
                  channel_count += 1

          # -----------------------------
          # 4. Copy programmes
          # -----------------------------
          programme_count = 0
          for prog in root.findall("programme"):
              if prog.attrib.get("channel") in tvg_ids:
                  new_root.append(prog)
                  programme_count += 1

          # -----------------------------
          # 5. Write epg.xml
          # -----------------------------
          ET.ElementTree(new_root).write(
              "epg.xml",
              encoding="utf-8",
              xml_declaration=True
          )

          print(f"Channels: {channel_count}")
          print(f"Programmes: {programme_count}")
          print("epg.xml generated successfully")
          EOF

      - name: Commit epg.xml
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add epg.xml
          git commit -m "Auto update XMLTV EPG" || echo "No changes"
          git push
