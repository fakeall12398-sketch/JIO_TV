name: Fetch channel.json

on:
  workflow_dispatch: {}        # manual run
  schedule:                    # automatic runs (every 6 hours)
    - cron: '0 */6 * * *'
  push:
    branches:
      - main

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Fetch channel.json from remote
        id: fetch
        run: |
          set -e
          TARGET_URL="https://livetv-hub.cricindia95.workers.dev/channel.json"
          OUT_PATH="data/channel.json"
          mkdir -p "$(dirname "$OUT_PATH")"

          # download to a temp file then move to OUT_PATH
          curl -fsSL "$TARGET_URL" -o "$OUT_PATH.tmp" || { echo "Failed to download $TARGET_URL"; exit 2; }

          # pretty-print / validate JSON (optional). If invalid, fail.
          if ! jq --version >/dev/null 2>&1; then
            echo "Installing jq..."
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          if ! jq . "$OUT_PATH.tmp" >/dev/null 2>&1; then
            echo "Downloaded file is not valid JSON. Aborting."
            cat "$OUT_PATH.tmp"
            exit 3
          fi

          # use jq to normalize formatting to avoid spurious diffs
          jq . "$OUT_PATH.tmp" > "$OUT_PATH"

          rm -f "$OUT_PATH.tmp"
          echo "Saved to $OUT_PATH"

      - name: Show git status (debug)
        run: |
          git status --porcelain
          ls -l data || true

      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if there are changes
          if ! git diff --quiet --exit-code; then
            git add data/channel.json
            # Compose informative commit message with timestamp
            COMMIT_MSG="Update channel.json from livetv-hub.cricindia95.workers.dev @ $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            git commit -m "$COMMIT_MSG" || echo "No changes to commit"
            # Push using the pre-provided GITHUB_TOKEN
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes detected; nothing to commit."
          fi
