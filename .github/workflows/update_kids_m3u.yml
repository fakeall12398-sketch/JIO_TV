name: ğŸ”„ Auto Update IPTV Tokens & License Keys

on:
  schedule:
    - cron: "0 */11 * * *"  # every 11 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ğŸ”„ Fetch Tokens from M3U Playlists and Update kids.m3u
        run: |
          python - <<'PYCODE'
          import re, requests

          M3U_FILE = "kids.m3u"
          PLAYLIST_URLS = [
              "https://fakeall12398-sketch.github.io/JIO_TV/jstar.m3u",
              "https://fakeall12398-sketch.github.io/JIO_TV/sony.m3u",
              "https://freelivtv.xyz/oppu/opplex.m3u",
              "https://fakeall12398-sketch.github.io/JIO_TV/Allinone.m3u"
          ]

          def fetch_tokens():
              tokens = {"hdnea": None, "hdntl": None, "license_key": None}
              pattern_hdnea = re.compile(r"__hdnea__=([^&\"\\s]+)")
              pattern_hdntl = re.compile(r"hdntl=([^&\"\\s]+)")
              pattern_license = re.compile(r"#KODIPROP:inputstream\.adaptive\.license_key=([^\n]+)")

              for url in PLAYLIST_URLS:
                  try:
                      print(f"[INFO] Fetching from {url}")
                      resp = requests.get(url, timeout=15)
                      text = resp.text
                      if not tokens["hdnea"]:
                          m = pattern_hdnea.search(text)
                          if m:
                              tokens["hdnea"] = m.group(1)
                      if not tokens["hdntl"]:
                          m = pattern_hdntl.search(text)
                          if m:
                              tokens["hdntl"] = m.group(1)
                      if not tokens["license_key"]:
                          m = pattern_license.search(text)
                          if m:
                              tokens["license_key"] = m.group(1).strip()
                      if all(tokens.values()):
                          break
                  except Exception as e:
                      print(f"[WARN] Failed {url}: {e}")
              return tokens

          def update_file(tokens):
              try:
                  content = open(M3U_FILE, encoding="utf-8").read()
              except FileNotFoundError:
                  print(f"[ERROR] {M3U_FILE} not found!")
                  return False

              updated = content
              if tokens["hdnea"]:
                  updated = re.sub(r"__hdnea__=[^&\"\\s]+", f"__hdnea__={tokens['hdnea']}", updated)
                  updated = re.sub(r"cookie=\"__hdnea__=[^\"}]+", f"cookie=\"__hdnea__={tokens['hdnea']}", updated)
              if tokens["hdntl"]:
                  updated = re.sub(r"hdntl=[^&\"\\s]+", f"hdntl={tokens['hdntl']}", updated)
              if tokens["license_key"]:
                  updated = re.sub(
                      r"(#KODIPROP:inputstream\.adaptive\.license_key=)[^\n]+",
                      f"\\1{tokens['license_key']}",
                      updated
                  )

              if updated != content:
                  open(M3U_FILE, "w", encoding="utf-8").write(updated)
                  print("[INFO] kids.m3u updated âœ…")
                  return True
              print("[INFO] No updates detected.")
              return False

          tokens = fetch_tokens()
          if not any(tokens.values()):
              print("[ERROR] No tokens found.")
              exit(1)
          changed = update_file(tokens)
          exit(0 if changed else 78)
          PYCODE

      - name: ğŸ’¾ Commit & Push Changes
        if: ${{ success() }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "No changes to commit."
          else
            git add kids.m3u
            git commit -m "ğŸ”„ Auto Update kids.m3u tokens [$(date '+%Y-%m-%d %H:%M:%S')]"
            git push
